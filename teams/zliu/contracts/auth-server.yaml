# Accord External Contract Template
# See PROTOCOL.md Section 2.1 for full specification.
#
# This file defines the API boundary for the auth-server service.
# Other modules interact with this service exclusively through this contract.
# Only the owning module may modify this file directly.
# To propose changes, use the Message Protocol (request files).

openapi: "3.0.3"

info:
  title: "auth-server API"
  version: "0.1.0"
  description: "API contract for the authentication and authorization service."

  # Accord-specific annotations:
  #   x-accord-status: Lifecycle status of this contract.
  #     draft      - Auto-generated by accord scan, needs human review.
  #     stable     - Reviewed and approved. Active contract.
  #     proposed   - A change has been proposed via a request.
  #     deprecated - Scheduled for removal.
  x-accord-status: draft

  # x-accord-scanned: ISO 8601 timestamp of when this contract was generated.
  #   Only present on contracts created by accord scan.
  x-accord-scanned: ""

paths:
  /api/auth/login:
    post:
      summary: "User login"
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  description: "User's username or email"
                password:
                  type: string
                  format: password
                  description: "User's password"
              required:
                - username
                - password
      responses:
        '200':
          description: "Successful login"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: "Invalid credentials"
        '400':
          description: "Bad request"

  /api/auth/logout:
    post:
      summary: "User logout"
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: "Successful logout"
        '401':
          description: "Unauthorized"

  /api/auth/register:
    post:
      summary: "User registration"
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  description: "Desired username"
                email:
                  type: string
                  format: email
                  description: "User's email address"
                password:
                  type: string
                  format: password
                  description: "User's password"
              required:
                - username
                - email
                - password
      responses:
        '201':
          description: "User created successfully"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '409':
          description: "Username or email already exists"
        '400':
          description: "Invalid input"

  /api/auth/validate:
    post:
      summary: "Validate JWT token"
      operationId: validateToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  description: "JWT token to validate"
              required:
                - token
      responses:
        '200':
          description: "Token is valid"
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  userId:
                    type: string
                  username:
                    type: string
        '401':
          description: "Invalid or expired token"

  /api/auth/refresh:
    post:
      summary: "Refresh access token"
      operationId: refreshToken
      security:
        - bearerAuth: []
      responses:
        '200':
          description: "Token refreshed successfully"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: "Invalid refresh token"

components:
  schemas:
    AuthResponse:
      type: object
      properties:
        accessToken:
          type: string
          description: "JWT access token"
        refreshToken:
          type: string
          description: "JWT refresh token"
        expiresIn:
          type: integer
          description: "Token expiration time in seconds"
        userId:
          type: string
          description: "Authenticated user ID"
      required:
        - accessToken
        - refreshToken
        - expiresIn
        - userId

    User:
      type: object
      properties:
        id:
          type: string
          description: "Unique user identifier"
        username:
          type: string
          description: "Username"
        email:
          type: string
          format: email
          description: "User's email address"
        createdAt:
          type: string
          format: date-time
          description: "Account creation timestamp"
      required:
        - id
        - username
        - email

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
